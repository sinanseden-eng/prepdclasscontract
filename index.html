<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prep D - Collaborative Class Contract</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .contract-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .signature-input {
            font-family: 'Dancing Script', cursive;
            border-bottom: 2px solid #4a5568;
            transition: border-color 0.3s;
        }
        .signature-input:focus {
            border-color: #764ba2;
            outline: none;
        }
        .list-disc li span[contenteditable="true"] {
            cursor: text; padding: 2px 4px; border-radius: 4px;
        }
        .list-disc li span[contenteditable="true"]:focus {
            outline: 2px solid #764ba2; background-color: rgba(118, 75, 162, 0.1);
        }
        .modal-overlay {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
            z-index: 50; transition: opacity 0.3s; background: rgba(0, 0, 0, 0.6);
        }
        .modal-window { min-width: 320px; max-width: 550px; }
        .gemini-content h3 { font-size: 1.1em; font-weight: bold; margin-top: 0.5em; margin-bottom: 0.5em; }
        .gemini-content ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; }
        .gemini-content li { margin-bottom: 0.25em; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        .print-only { display: none; }

        /* --- PRINT STYLES --- */
        @media print {
            body {
                background: none; font-size: 10pt;
            }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .contract-card {
                box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important;
                width: 100%; max-width: 100%; backdrop-filter: none; background: none;
            }
            .main-grid {
                grid-template-columns: 1fr !important;
            }
            header h1 { font-size: 20pt; }
            h2 { font-size: 14pt; margin-bottom: 0.5rem; }
            .signature-section h2 { page-break-before: auto; }
            .signature-item {
                border: 1px solid #ccc; box-shadow: none; font-size: 11pt; padding: 2px 6px;
            }
            .digital-signatures-container { page-break-inside: avoid; }
            body, .contract-card {
                height: auto; min-height: 0;
            }
            #physical-signatures-list {
                 grid-template-columns: repeat(3, 1fr);
                 gap: 1.5rem 2rem;
            }
            #physical-signatures-list div {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
                text-align: center;
                font-family: 'Poppins', sans-serif;
                font-size: 10pt;
            }
        }
    </style>
     <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-2 sm:p-4">
    <div class="contract-card w-full max-w-5xl rounded-2xl shadow-2xl p-6 md:p-8 relative">
        <!-- Loading Indicator -->
        <div id="loading-overlay" class="fixed inset-0 bg-white/80 flex items-center justify-center z-50 rounded-2xl">
             <div class="text-center">
                <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-purple-600 mx-auto"></div>
                <p class="mt-4 font-semibold text-gray-700">Connecting to the classroom...</p>
            </div>
        </div>

        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Our Prep D Class Contract</h1>
            <div class="flex justify-center items-center gap-4 mt-2">
                <p class="text-gray-600 text-sm md:text-base">A shared agreement for a great year of learning!</p>
                <button id="summarize-contract-btn" title="Summarize the spirit of the contract" class="no-print bg-purple-100 text-purple-700 p-2 rounded-full hover:bg-purple-200 transition">✨</button>
            </div>
        </header>

        <div class="main-grid grid md:grid-cols-2 gap-x-8 gap-y-6 mb-6">
            <div>
                <h2 class="text-xl font-bold text-purple-700 mb-3 border-b-2 border-purple-200 pb-2">The Students of Prep D will...</h2>
                <ul id="student-rules" class="list-disc list-inside space-y-2 text-gray-700">
                    <!-- Rules will be loaded by JavaScript -->
                </ul>
                 <button id="add-student-rule-btn" class="no-print mt-3 text-sm font-semibold text-purple-600 hover:text-purple-800 transition-colors">+ Add a new rule</button>
            </div>
            <div>
                <h2 class="text-xl font-bold text-teal-700 mb-3 border-b-2 border-teal-200 pb-2">The Teacher of Prep D will...</h2>
                <ul id="teacher-rules" class="list-disc list-inside space-y-2 text-gray-700">
                    <!-- Rules will be loaded by JavaScript -->
                </ul>
                 <button id="add-teacher-rule-btn" class="no-print mt-3 text-sm font-semibold text-teal-600 hover:text-teal-800 transition-colors">+ Add a new rule</button>
            </div>
        </div>

        <div class="signature-section text-center">
             <div class="no-print">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Digital Signatures</h2>
                <p class="text-gray-600 mb-4 text-sm">By typing your name below, you agree to follow our class contract.</p>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-4">
                    <input type="text" id="signature-name" placeholder="Type your full name here" class="w-full sm:w-2/3 bg-transparent text-2xl text-center signature-input p-2 text-gray-700">
                    <button id="sign-button" class="bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600 transition-transform transform hover:scale-105 shadow-lg">
                        Sign the Contract
                    </button>
                </div>
            </div>
            <div id="digital-signatures-container" class="digital-signatures-container">
                 <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">Signed By:</h3>
                 <div id="signatures-list" class="flex flex-wrap justify-center gap-3">
                    <!-- Signatures will appear here -->
                </div>
            </div>
            <div class="print-only mt-6">
                 <div id="physical-signatures-list" class="grid">
                     <!-- Populated by JS for printing -->
                 </div>
            </div>
        </div>
        
        <div class="absolute top-4 right-4 flex gap-2 no-print">
            <button id="print-btn" class="bg-gray-200 text-gray-700 p-2 rounded-full hover:bg-gray-300 transition" title="Print Contract">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
            </button>
             <button id="api-key-btn" class="bg-gray-600 text-white p-2 rounded-full hover:bg-gray-700 transition" title="Set API Key">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="gemini-modal" class="modal-overlay hidden no-print">
        <div class="modal-window bg-white rounded-lg shadow-xl p-6 relative fade-in">
             <button id="close-gemini-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
             <h3 id="gemini-title" class="text-2xl font-bold text-gray-800 mb-4">✨ AI Assistant</h3>
             <div id="gemini-content" class="gemini-content text-gray-700 max-h-80 overflow-y-auto"></div>
        </div>
    </div>
    <div id="api-key-modal" class="modal-overlay hidden no-print">
        <div class="modal-window bg-white rounded-lg shadow-xl p-6 relative fade-in">
             <button id="close-api-key-modal" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
             <h3 class="text-2xl font-bold text-gray-800 mb-4">⚙️ Gemini API Key</h3>
             <p class="text-gray-600 mb-4">Please enter your Gemini API key to enable AI features. Your key is saved securely in your browser.</p>
             <input type="password" id="api-key-input" class="w-full px-3 py-2 border rounded-md" placeholder="Enter your API Key here...">
             <button id="save-api-key-btn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">Save Key</button>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- USER CONFIGURATION ---
        // IMPORTANT: When deploying to a service like Netlify,
        // replace the placeholder values below with your own Firebase project's configuration.
        // You can find these details in your Firebase project settings.
        const userFirebaseConfig = {
            apiKey: "AIzaSy...YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // -------------------------

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const studentRulesList = document.getElementById('student-rules');
            const teacherRulesList = document.getElementById('teacher-rules');
            const addStudentRuleBtn = document.getElementById('add-student-rule-btn');
            const addTeacherRuleBtn = document.getElementById('add-teacher-rule-btn');
            const signaturesList = document.getElementById('signatures-list');
            const signButton = document.getElementById('sign-button');
            const signatureNameInput = document.getElementById('signature-name');
            const printBtn = document.getElementById('print-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            const geminiModal = document.getElementById('gemini-modal');
            const geminiTitle = document.getElementById('gemini-title');
            const geminiContent = document.getElementById('gemini-content');
            const closeGeminiModalBtn = document.getElementById('close-gemini-modal');
            const apiKeyModal = document.getElementById('api-key-modal');
            const closeApiKeyModalBtn = document.getElementById('close-api-key-modal');
            const apiKeyBtn = document.getElementById('api-key-btn');
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            const summarizeBtn = document.getElementById('summarize-contract-btn');
            const physicalSignaturesList = document.getElementById('physical-signatures-list');


            // Local State
            let contractDocRef;
            let localSignedNames = [];
            let apiKey = "";

            // --- FIREBASE SETUP ---
            // Use the configuration from the Canvas environment if it exists,
            // otherwise, use the user-provided configuration from above.
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'prep-d-contract';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

            async function initializeFirebase() {
                try {
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } else { await signInAnonymously(auth); }
                    contractDocRef = doc(db, `/artifacts/${appId}/public/data/classContracts`, "prepDContract");
                    onSnapshot(contractDocRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            renderRules(data.studentRules || [], data.teacherRules || []);
                            renderSignatures(data.signatures || []);
                        } else {
                            initializeContractDocument();
                        }
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => loadingOverlay.style.display = 'none', 300);
                    });
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    loadingOverlay.innerHTML = `<p class="text-red-500 font-semibold">Could not connect to the classroom. Please check the console.</p>`;
                }
            }
            
            // --- GEMINI API INTEGRATION ---
            async function callGemini(prompt, systemInstruction) {
                const userApiKey = localStorage.getItem('geminiApiKey_prepD');
                const effectiveApiKey = userApiKey || apiKey;
                if (!effectiveApiKey) {
                    alert("Please set your Gemini API key first.");
                    apiKeyModal.classList.remove('hidden');
                    return null;
                }
                geminiContent.innerHTML = '<div class="w-8 h-8 border-4 border-dashed rounded-full animate-spin border-purple-600 mx-auto"></div>';
                geminiModal.classList.remove('hidden');
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${effectiveApiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                if (systemInstruction) {
                    payload.systemInstruction = { parts: [{ text: systemInstruction }] };
                }
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text || 'Sorry, I could not get a response from the AI assistant.';
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return 'An error occurred. Please check the console for details.';
                }
            }

            async function handleExplainRule(ruleText) {
                geminiTitle.textContent = '✨ Rule Explanation';
                const systemPrompt = "You are a helpful and friendly teacher's assistant. Explain in simple terms why the following classroom rule is important and give a positive example of how it helps everyone learn. Respond in English.";
                const userPrompt = `The rule is: "${ruleText}"`;
                const explanation = await callGemini(userPrompt, systemPrompt);
                if (explanation) { geminiContent.innerHTML = explanation.replace(/\n/g, '<br>'); }
            }
            
            async function handleSummarizeContract() {
                geminiTitle.textContent = '✨ Spirit of the Contract';
                const studentRules = Array.from(studentRulesList.querySelectorAll("span")).map(span => `- ${span.textContent.trim()}`).join('\n');
                const teacherRules = Array.from(teacherRulesList.querySelectorAll("span")).map(span => `- ${span.textContent.trim()}`).join('\n');
                const systemPrompt = "Act as a student council president. Summarize the following class contract into one positive and encouraging paragraph that captures the main spirit of the agreement. The contract has two parts: student responsibilities and teacher responsibilities. Respond in English.";
                const userPrompt = `Student Rules:\n${studentRules}\n\nTeacher Rules:\n${teacherRules}`;
                const summary = await callGemini(userPrompt, systemPrompt);
                if(summary) { geminiContent.innerHTML = summary.replace(/\n/g, '<br>'); }
            }

            // --- DATA RENDERING ---
            function renderRules(studentRules, teacherRules) {
                studentRulesList.innerHTML = studentRules.map(rule => createRuleListItem(rule)).join('');
                teacherRulesList.innerHTML = teacherRules.map(rule => createRuleListItem(rule)).join('');
            }
            
            function renderSignatures(signatures) {
                localSignedNames = signatures;

                // Render digital signatures for screen
                signaturesList.innerHTML = signatures.length === 0 ? '<p class="text-gray-500">No signatures yet.</p>' : '';
                if (signatures.length > 0) {
                    signaturesList.innerHTML = ''; 
                    signatures.forEach(name => {
                        const signatureDiv = document.createElement('div');
                        signatureDiv.className = 'signature-item bg-gray-100 text-gray-800 font-semibold py-1 px-3 rounded-lg shadow-sm';
                        signatureDiv.style.fontFamily = "'Dancing Script', cursive";
                        signatureDiv.style.fontSize = '1.1rem';
                        signatureDiv.textContent = name;
                        signaturesList.appendChild(signatureDiv);
                    });
                }
                
                // Render signatures and blank lines for printing
                physicalSignaturesList.innerHTML = '';
                const totalPrintSlots = 24;
                for (let i = 0; i < totalPrintSlots; i++) {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'border-b border-gray-400';
                    if (signatures[i]) {
                        lineDiv.textContent = signatures[i];
                    }
                    physicalSignaturesList.appendChild(lineDiv);
                }
            }
            
            function createRuleListItem(text) {
                 return `<li class="relative pr-12 group flex items-center">
                    <span contenteditable="true" class="block flex-grow">${text}</span>
                    <button class="explain-rule-btn no-print text-purple-400 hover:text-purple-600 font-bold opacity-0 group-hover:opacity-100 transition-opacity mx-2" title="Explain this rule">✨</button>
                    <button class="delete-rule-btn no-print text-red-400 hover:text-red-600 font-bold opacity-0 group-hover:opacity-100 transition-opacity text-xl leading-none">&times;</button>
                </li>`;
            }

            // --- DATA MODIFICATION (WRITING TO FIRESTORE) ---
            async function initializeContractDocument() {
                const defaultStudentRules = ["Try to speak as much English as possible.", "Listen while the teacher is giving instructions or another student is giving an answer.", "Arrive on time to the class.", "Respect each other's opinions in class.", "Show a positive attitude, motivating each other if they make a mistake.", "Upload homework and assignments before the deadline.", "Work seriously during group work and show their best effort.", "Have paper and pencil ready if their tablet is not charged."];
                const defaultTeacherRules = ["Arrive on time to the class and finish the class on time.", "Provide a safe learning environment where every student can express themselves freely.", "Provide a fun and interactive learning environment with a variety of activities and games.", "Make the best effort for every student to participate and be active."];
                await setDoc(contractDocRef, { studentRules: defaultStudentRules, teacherRules: defaultTeacherRules, signatures: [] });
            }

            async function saveContractRules() {
                if (!contractDocRef) return;
                const studentRules = Array.from(studentRulesList.querySelectorAll("span")).map(span => span.textContent.trim()).filter(rule => rule);
                const teacherRules = Array.from(teacherRulesList.querySelectorAll("span")).map(span => span.textContent.trim()).filter(rule => rule);
                await setDoc(contractDocRef, { studentRules, teacherRules }, { merge: true });
            }

            async function addSignatureToFirebase(name) {
                if (!contractDocRef) return;
                await updateDoc(contractDocRef, { signatures: arrayUnion(name) });
            }

            // --- EVENT LISTENERS ---
            signButton.addEventListener('click', async () => {
                const name = signatureNameInput.value.trim();
                if (name && !localSignedNames.includes(name)) {
                    await addSignatureToFirebase(name);
                    signatureNameInput.value = '';
                } else if (localSignedNames.includes(name)) {
                    alert('This name has already signed the contract.');
                } else {
                    alert('Please type your name before signing.');
                }
            });
            
            signatureNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    signButton.click();
                }
            });

            function addNewRule(listElement) {
                const newItemHTML = createRuleListItem('New rule...');
                listElement.insertAdjacentHTML('beforeend', newItemHTML);
                const newItemSpan = listElement.lastElementChild.querySelector('span');
                newItemSpan.focus();
                document.execCommand('selectAll', false, null);
            }
            
            addStudentRuleBtn.addEventListener('click', () => addNewRule(studentRulesList));
            addTeacherRuleBtn.addEventListener('click', () => addNewRule(teacherRulesList));

            function setupListListeners(listElement) {
                listElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-rule-btn')) { e.target.closest('li').remove(); saveContractRules(); }
                    if (e.target.classList.contains('explain-rule-btn')) { const ruleText = e.target.closest('li').querySelector('span').textContent; handleExplainRule(ruleText); }
                });
                listElement.addEventListener('blur', (e) => {
                    if (e.target.tagName === 'SPAN' && e.target.isContentEditable) {
                        if(e.target.innerHTML !== e.target.textContent) { e.target.innerHTML = e.target.textContent; }
                        saveContractRules();
                    }
                }, true);
            }
            
            setupListListeners(studentRulesList);
            setupListListeners(teacherRulesList);
            
            printBtn.addEventListener('click', () => window.print());
            closeGeminiModalBtn.addEventListener('click', () => geminiModal.classList.add('hidden'));
            apiKeyBtn.addEventListener('click', () => { apiKeyInput.value = localStorage.getItem('geminiApiKey_prepD') || ''; apiKeyModal.classList.remove('hidden'); });
            closeApiKeyModalBtn.addEventListener('click', () => apiKeyModal.classList.add('hidden'));
            saveApiKeyBtn.addEventListener('click', () => { localStorage.setItem('geminiApiKey_prepD', apiKeyInput.value); apiKeyModal.classList.add('hidden'); alert('API Key saved!'); });
            summarizeBtn.addEventListener('click', handleSummarizeContract);

            // --- INITIALIZE APP ---
            initializeFirebase();
        });
    </script>
</body>
</html>


